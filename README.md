# BLC

## Branch length correlation of gene trees and species trees

**Note:** I'm currently testing these scripts after some changes.   

This is a test to filter contamination in phylogenomic datasets based on [Simion et al. (2017) in *Current Biology*](https://www.sciencedirect.com/science/article/pii/S0960982217301999). The code here was used as part of the quality control pipeline by [Arcila et al. (2021) in *Systematic Biology*](https://academic.oup.com/sysbio/article-abstract/70/6/1123/6204118).

There are four main steps:
1. Infer a Maximum Likelihood (ML) tree for all your concatenated genes
2. Create a set of contraint trees from the concatenated ML topology with only the taxa present in each gene
3. Infer ML gene trees that are constrained to the concatenated ML topology
4. Correlate the terminal branch lengths for each taxon in the constrained gene tree with the concatenated ML tree

Gene sequences that are potentially contaminated, paralogous, misassembled or misaligned, should have excessively long branch lengths in the constrained gene trees. These sequences are then flagged and removed from downstream analyses. 

## Required Software
* [Python3](https://www.anaconda.com)
* [ete3](http://etetoolkit.org) 
* [IQ-TREE](http://www.iqtree.org) or RAxML (instructions for IQ-TREE are below)

## Install dependencies with conda
```
conda create -n blc python=3
conda activate blc
conda install -c bioconda iqtree
conda install -c etetoolkit ete3 ete_toolchain
conda deactivate
```

When you are ready to run your analysis, remember to type:

`conda activate blc`

## Running a BLC Analysis

### 1. Generate an initial concatenated tree

For a full list of options, please consult the [IQ-TREE manual](http://www.iqtree.org/doc/). A simple analysis might look like:

```
iqtree -s Concatenated.fasta -m GTR+G4 -T AUTO
```

### 2. Generate gene tree constraints

Put all of your individual gene alignments into a single directory. They must be FASTA-formatted. ConstraintTreeMaker.py will make constraint trees for each alignment file, based on the concatenated ML topology. These trees will end in .constraint.

The script ConstraintTreeMaker.py has three arguments:
- -c: The concatenated ML topology generated by the previous step.
- -a: The full path to the directory with your FASTA-formated gene alignments.
- -e: The extension for the gene alignment files. The default is .fasta.

```
python3 ConstraintTreeMaker.py -c Concatenated.treefile -a /path/to/alignments/ -e .fasta
```

### 3. Generate constrained gene trees

This step calculates branch lengths from the gene alignments under the constrained topology. It runs relatively quickly, since there is no topology search. An example loop might look like this:

```
for f in *.fasta;
do
iqtree -s $f -g $f.constraint -m GTR+G4 -T 1;
done
```

### 4. Run the BLC analysis

Now that you have (1) a concatenated ML tree, and (2) gene trees with the same topology but estimated branch lengths, you need one more **file designating the outgroup taxa** to run BLC.py. This is just a text file with one outgroup taxon name per line.

**More info goes here**

### 5. Prune outlier sequences from gene alignments for downstream analysis

**More info goes here**