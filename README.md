# BLC: Branch-length correlation of gene trees and a species tree

This is a test to filter contamination in phylogenomic datasets based on [Simion et al. (2017) in *Current Biology*](https://www.sciencedirect.com/science/article/pii/S0960982217301999). The code here was used as part of the quality control pipeline by [Arcila et al. (2021) in *Systematic Biology*](https://academic.oup.com/sysbio/article-abstract/70/6/1123/6204118).

There are four main steps:
1. Infer a Maximum Likelihood (ML) tree for all your concatenated genes
2. Create a set of contraint trees from the concatenated ML topology with only the taxa present in each gene
3. Infer ML gene trees that are constrained to the concatenated ML topology
4. Correlate the terminal branch lengths for each taxon in the constrained gene tree with the concatenated ML tree

Gene sequences that are potentially contaminated, paralogous, misassembled or misaligned, should have excessively long branch lengths in the constrained gene trees. These sequences are then flagged and removed from downstream analyses. 

## Required Software
* [Python3](https://www.anaconda.com)
* [ete3](http://etetoolkit.org) 
* [Biopython](https://biopython.org)
* [IQ-TREE](http://www.iqtree.org) or RAxML (example with IQ-TREE below)

## Install dependencies with conda
```
conda create -n blc python=3
conda activate blc
conda install -c bioconda iqtree
conda install -c conda-forge biopython
conda install -c etetoolkit ete3 ete_toolchain
conda deactivate
```

When you are ready to run your analysis, remember to type:

`conda activate blc`

## Running a BLC Analysis

### 1. Generate an initial concatenated tree

For a full list of options, please consult the [IQ-TREE manual](http://www.iqtree.org/doc/). A simple analysis might look like:

```
iqtree -s Concatenated.fasta -m GTR+G4 -T AUTO
```

### 2. Generate gene tree constraints

Put all of your individual gene alignments into a single directory. They must be FASTA-formatted. ConstraintTreeMaker.py will make constraint trees for each alignment file, based on the concatenated ML topology. These trees will end in .constraint.

The script ConstraintTreeMaker.py has three arguments:
- -c: The concatenated ML topology generated by the previous step.
- -a: The path to the directory with your FASTA-formated gene alignments.
- -e: The extension for the gene alignment files. (Default= .fasta)

```
python3 ConstraintTreeMaker.py -c Concatenated.treefile -a /path/to/alignments/ -e .fasta
```

### 3. Generate constrained gene trees

This step calculates branch lengths from the gene alignments under the constrained topology. It runs relatively quickly, since there is no topology search. An example loop might look like this:

```
for f in *.fasta;
do
iqtree -s $f -g $f.constraint -m GTR+G4 -T 1;
done
```

### 4. Run the BLC analysis

Now that you have (1) a concatenated ML tree, and (2) gene trees with the same topology but estimated branch lengths, you need one more **file designating the outgroup taxa** to run BLC.py. This is just a text file with one outgroup taxon name per line.

The script BLC.py has five arguments:
- -g: The path to the directory with your estimated gene trees.
- -e: The file extension for your estimated gene trees. (Default= .treefile)
- -c: The concatenated ML tree (estimated in step 1).
- -r: The threshold above which taxa will be flagged for removal. Default is 5, i.e. the terminal branch length in the gene tree is 5X greater than the terminal branch in the concatenated tree.
- -o: The file listing one outgroup taxon per line.

```
python3 BLC.py -g /path/to/estimated/genetrees/ -e .treefile -c Concatenated.treefile -r 5 -o outgroups.txt
```

BLC.py outputs 1-2 files per gene tree in the same directory as your estimated gene trees. The first file is the R-squared value for the terminal branch lengths of the gene tree and concatenated tree (**ending in .R2.txt**). The second output is a list of taxa if they were flagged for long branches for that gene (**ending in .flagged_taxa.txt**). 

> **A note about the R-squared values:** While I often examine gene trees where R-squared is very low, this can sometimes just be due to short branch lengths in the gene tree, which is not necessarily a cause for concern. Short loci often have only a small amount of phylogenetic information.

### 5. Prune outlier sequences from gene alignments for downstream analysis

To remove taxa flagged by BLC.py from your gene alignments, use the DropTaxaBLC.py script. 

DropTaxaBLC.py has only two arguments:
- -a: The path to the directory with your FASTA-formated gene alignments.
- -e: -e: The extension for the gene alignment files. (Default= .fasta)

```
python3 DropTaxaBLC.py -a /path/to/gene/alignments/ -e .fasta
```

This script will remove the taxa flagged by BLC.py. It will append the alignment file name with .BLC_cleaned.
